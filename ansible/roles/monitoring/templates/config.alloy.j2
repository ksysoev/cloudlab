// Grafana Alloy Configuration for {{ swarm_instance_name }}
// Managed by Ansible - DO NOT EDIT MANUALLY

logging {
  level  = "info"
  format = "logfmt"
}

{% if grafana_cloud_logs_url != "" %}
// Grafana Cloud Loki endpoint for logs
loki.write "grafana_cloud_loki" {
  endpoint {
    url = "{{ grafana_cloud_logs_url }}"
    basic_auth {
      username = "{{ grafana_cloud_logs_id }}"
      password = "{{ grafana_cloud_api_key }}"
    }
  }
}
{% else %}
// Local Loki endpoint (Grafana Cloud not configured)
loki.write "grafana_cloud_loki" {
  endpoint {
    url = "http://localhost:3100/loki/api/v1/push"
  }
}
{% endif %}

{% if grafana_cloud_metrics_url != "" %}
// Grafana Cloud Prometheus endpoint for metrics
prometheus.remote_write "metrics_service" {
  endpoint {
    url = "{{ grafana_cloud_metrics_url }}"
    basic_auth {
      username = "{{ grafana_cloud_metrics_id }}"
      password = "{{ grafana_cloud_api_key }}"
    }
  }
}
{% endif %}

// Node exporter for system metrics
prometheus.exporter.unix "integrations_node_exporter" {
  disable_collectors = ["ipvs", "btrfs", "infiniband", "xfs", "zfs"]

  filesystem {
    fs_types_exclude     = "^(autofs|binfmt_misc|bpf|cgroup2?|configfs|debugfs|devpts|devtmpfs|tmpfs|fusectl|hugetlbfs|iso9660|mqueue|nsfs|overlay|proc|procfs|pstore|rpc_pipefs|securityfs|selinuxfs|squashfs|sysfs|tracefs)$"
    mount_points_exclude = "^/(dev|proc|run/credentials/.+|sys|var/lib/docker/.+)($|/)"
    mount_timeout        = "5s"
  }

  netclass {
    ignored_devices = "^(veth.*|cali.*|[a-f0-9]{15})$"
  }

  netdev {
    device_exclude = "^(veth.*|cali.*|[a-f0-9]{15})$"
  }
}

// Add proper labels to node exporter metrics
discovery.relabel "integrations_node_exporter" {
  targets = prometheus.exporter.unix.integrations_node_exporter.targets

  rule {
    target_label = "instance"
    replacement  = "{{ swarm_instance_name }}"
  }

  rule {
    target_label = "job"
    replacement = "integrations/node_exporter"
  }
}

{% if grafana_cloud_metrics_url != "" %}
// Scrape node exporter metrics
prometheus.scrape "integrations_node_exporter" {
  targets    = discovery.relabel.integrations_node_exporter.output
  forward_to = [prometheus.relabel.integrations_node_exporter.receiver]
}

// Filter and forward metrics
prometheus.relabel "integrations_node_exporter" {
  forward_to = [prometheus.remote_write.metrics_service.receiver]

  rule {
    source_labels = ["__name__"]
    regex         = "up|node_cpu_seconds_total|node_load1|node_load5|node_load15|node_memory_MemAvailable_bytes|node_memory_MemFree_bytes|node_memory_MemTotal_bytes|node_memory_Cached_bytes|node_memory_Buffers_bytes|node_filesystem_avail_bytes|node_filesystem_size_bytes|node_disk_read_bytes_total|node_disk_written_bytes_total|node_network_receive_bytes_total|node_network_transmit_bytes_total"
    action        = "keep"
  }
}
{% endif %}

// Docker container logs collection
discovery.docker "logs_integrations_docker" {
  host             = "unix:///var/run/docker.sock"
  refresh_interval = "5s"
}

discovery.relabel "logs_integrations_docker" {
  targets = discovery.docker.logs_integrations_docker.targets

  rule {
    target_label = "job"
    replacement  = "integrations/docker"
  }

  rule {
    target_label = "instance"
    replacement  = "{{ swarm_instance_name }}"
  }

  rule {
    source_labels = ["__meta_docker_container_name"]
    regex         = "/(.*)"
    target_label  = "container"
  }

  rule {
    source_labels = ["__meta_docker_container_log_stream"]
    target_label  = "stream"
  }
}

loki.source.docker "logs_integrations_docker" {
  host             = "unix:///var/run/docker.sock"
  targets          = discovery.docker.logs_integrations_docker.targets
  forward_to       = [loki.write.grafana_cloud_loki.receiver]
  relabel_rules    = discovery.relabel.logs_integrations_docker.rules
  refresh_interval = "5s"
}
