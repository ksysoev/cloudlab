#cloud-config

# Update and upgrade system packages
package_update: true
package_upgrade: true

packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - lsb-release
  - unattended-upgrades
  - fail2ban
  - ufw
  - jq

# Preserve default root user and create the deployer user for GitHub Actions deployments
users:
  - default
  - name: deployer
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    shell: /bin/bash
    ssh_authorized_keys:
      - ${deployer_ssh_key}

# Write configuration files
write_files:
  # Docker daemon configuration (directory created in runcmd before Docker install)
  - path: /etc/docker/daemon.json
    permissions: '0644'
    content: |
      {
        "log-driver": "json-file",
        "log-opts": {
          "max-size": "10m",
          "max-file": "3"
        },
        "metrics-addr": "127.0.0.1:9323",
        "experimental": false
      }

  # Fail2ban SSH jail configuration for custom port
  - path: /etc/fail2ban/jail.local
    permissions: '0644'
    content: |
      [sshd]
      enabled = true
      port = ${ssh_port}
      filter = sshd
      logpath = /var/log/auth.log
      maxretry = 5
      bantime = 3600

  # Grafana Alloy configuration template
  - path: /tmp/alloy-config.alloy
    permissions: '0644'
    content: |
      // Grafana Alloy Configuration
      // This is a basic configuration that can be customized per project
      
      logging {
        level  = "info"
        format = "logfmt"
      }

      // Docker metrics collection
      prometheus.exporter.unix "default" {
        enable_collectors = ["cpu", "diskstats", "filesystem", "loadavg", "meminfo", "netdev", "stat", "time"]
      }

      // Collect Docker container logs
      discovery.docker "containers" {
        host = "unix:///var/run/docker.sock"
      }

      loki.source.docker "default" {
        host       = "unix:///var/run/docker.sock"
        targets    = discovery.docker.containers.targets
        forward_to = [loki.write.default.receiver]
      }

      // Configure Grafana Cloud endpoints (if provided)
      %{ if grafana_cloud_logs_url != "" }
      loki.write "default" {
        endpoint {
          url = "${grafana_cloud_logs_url}"
          basic_auth {
            username = "${grafana_cloud_logs_id}"
            password = "${grafana_cloud_api_key}"
          }
        }
      }
      %{ else }
      // No Grafana Cloud logs endpoint configured
      // Logs will be stored locally only
      loki.write "default" {
        endpoint {
          url = "http://localhost:3100/loki/api/v1/push"
        }
      }
      %{ endif }

      %{ if grafana_cloud_metrics_url != "" }
      prometheus.remote_write "default" {
        endpoint {
          url = "${grafana_cloud_metrics_url}"
          basic_auth {
            username = "${grafana_cloud_metrics_id}"
            password = "${grafana_cloud_api_key}"
          }
        }
      }
      %{ endif }

  # Grafana Alloy Docker Compose file
  - path: /opt/cloudlab/alloy/docker-compose.yml
    permissions: '0644'
    content: |
      version: '3.8'

      services:
        alloy:
          image: grafana/alloy:latest
          container_name: grafana-alloy
          restart: unless-stopped
          volumes:
            - /tmp/alloy-config.alloy:/etc/alloy/config.alloy:ro
            - /var/run/docker.sock:/var/run/docker.sock:ro
            - /var/log:/var/log:ro
            - /:/rootfs:ro
            - /sys:/sys:ro
            - /proc:/proc:ro
          ports:
            - "12345:12345"  # Alloy UI
          command:
            - run
            - /etc/alloy/config.alloy
            - --server.http.listen-addr=0.0.0.0:12345
          network_mode: host
          deploy:
            mode: global
            restart_policy:
              condition: any
              delay: 5s

  # Init script for Docker Swarm
  - path: /usr/local/bin/init-swarm.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e

      echo "Initializing Docker Swarm..."
      
      # Get the droplet's public IP
      PUBLIC_IP=$(curl -s http://169.254.169.254/metadata/v1/interfaces/public/0/ipv4/address)
      
      # Initialize swarm if not already initialized
      if ! docker info | grep -q "Swarm: active"; then
        docker swarm init --advertise-addr $PUBLIC_IP
        echo "Docker Swarm initialized with manager at $PUBLIC_IP"
      else
        echo "Docker Swarm already initialized"
      fi

      # Deploy Grafana Alloy only if endpoint is configured
      if [ -n "${grafana_cloud_logs_url}" ] || [ -n "${grafana_cloud_metrics_url}" ]; then
        echo "Deploying Grafana Alloy..."
        cd /opt/cloudlab/alloy
        docker stack deploy -c docker-compose.yml monitoring || echo "Alloy deployment failed (please check configuration)"
      else
        echo "Grafana Cloud endpoints not configured; skipping Grafana Alloy deployment."
        echo "To deploy Alloy later, configure your endpoints and run:"
        echo "  cd /opt/cloudlab/alloy && docker stack deploy -c docker-compose.yml monitoring"
      fi

      echo "Swarm initialization complete!"
      echo "Manager join token:"
      docker swarm join-token manager
      echo ""
      echo "Worker join token:"
      docker swarm join-token worker

runcmd:
  # Create /etc/docker before Docker install so daemon.json (from write_files) is preserved
  - mkdir -p /etc/docker

  # Install Docker
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
  - echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

  # Enable and start Docker (daemon.json already in place from write_files)
  - systemctl enable docker
  - systemctl restart docker

  # Add deployer to docker group (group created by Docker install)
  - usermod -aG docker deployer

  # Configure automatic security updates
  - echo 'APT::Periodic::Update-Package-Lists "1";' > /etc/apt/apt.conf.d/20auto-upgrades
  - echo 'APT::Periodic::Unattended-Upgrade "1";' >> /etc/apt/apt.conf.d/20auto-upgrades

  # Configure UFW firewall BEFORE changing SSH port
  - ufw --force reset
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow ${ssh_port}/tcp comment 'SSH on custom port'
  - ufw allow 80/tcp comment 'HTTP'
  - ufw allow 443/tcp comment 'HTTPS TCP'
  - ufw allow 443/udp comment 'HTTPS UDP (HTTP/3)'
  - ufw allow 8081/tcp comment 'Custom application port'
  - ufw --force enable

  # Change SSH port to ${ssh_port} and restart (after UFW allows the new port)
  - mkdir -p /etc/ssh/sshd_config.d
  - echo "Port ${ssh_port}" > /etc/ssh/sshd_config.d/custom_port.conf
  - systemctl restart ssh

  # Start fail2ban (jail.local already in place from write_files with custom SSH port)
  - systemctl enable fail2ban
  - systemctl restart fail2ban

  # Create cloudlab directory structure
  - mkdir -p /opt/cloudlab/alloy
  - mkdir -p /opt/cloudlab/scripts
  - mkdir -p /opt/cloudlab/stacks

  # Initialize Docker Swarm
  - /usr/local/bin/init-swarm.sh

  # Set correct permissions
  - chown -R deployer:deployer /opt/cloudlab

final_message: "CloudLab Docker Swarm node is ready! Duration: $UPTIME seconds"
