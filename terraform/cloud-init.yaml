#cloud-config
# CloudLab Bootstrap Configuration
# Minimal cloud-init for initial droplet setup
# All other configuration is managed by Ansible

# Update system packages
package_update: true
package_upgrade: true

# Install Ansible dependencies only
packages:
  - python3
  - python3-apt
  - curl

# Create deployer user for Ansible to connect
users:
  - default
  - name: deployer
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    shell: /bin/bash
    groups: users
    ssh_authorized_keys:
      - ${deployer_ssh_key}

# Minimal SSH hardening (so Ansible can connect securely)
runcmd:
  # Configure SSH on custom port with basic hardening
  - mkdir -p /etc/ssh/sshd_config.d
  - echo "Port ${ssh_port}" > /etc/ssh/sshd_config.d/bootstrap.conf
  - echo "PermitRootLogin no" >> /etc/ssh/sshd_config.d/bootstrap.conf
  - echo "PasswordAuthentication no" >> /etc/ssh/sshd_config.d/bootstrap.conf
  - systemctl restart ssh

# Reboot to apply kernel upgrades
power_state:
  delay: now
  mode: reboot
  message: "Rebooting after bootstrap to apply kernel upgrades"
  condition: true

final_message: "CloudLab bootstrap complete! Ready for Ansible configuration. Duration: $UPTIME seconds"
